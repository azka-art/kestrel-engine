name: ğŸ¦… Kestrel Engine - Complete Hunt Mission

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - '.github/workflows/**'
  
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test Suite to Execute'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api
          - web
          - smoke
          - e2e
      environment:
        description: 'Environment Configuration'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
      browser:
        description: 'Browser for Web Tests'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2'

jobs:
  # Quality Gates
  quality-check:
    name: ğŸ” Quality Gates & Static Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout Kestrel Engine
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: ğŸ—ï¸ Setup Gradle
      uses: gradle/gradle-build-action@v2
      
    - name: ğŸ“Š Run Quality Analysis
      run: |
        chmod +x gradlew
        ./gradlew clean compileTestJava checkstyleTest --info
        
    - name: ğŸ“‹ Generate Quality Report
      run: echo "âœ… Quality gates passed - Kestrel Engine ready for hunt"

  # API Hunt Mission
  api-hunt:
    name: ğŸ¯ API Hunt - JSONPlaceholder Mission
    runs-on: ubuntu-latest
    if: |
      (github.event.inputs.suite == 'all' || github.event.inputs.suite == 'api' || github.event.inputs.suite == 'smoke') ||
      github.event_name == 'pull_request'
    
    strategy:
      matrix:
        test-group: [users, posts]
        include:
          - test-group: users
            tags: '@api and @smoke'
          - test-group: posts  
            tags: '@api and not @smoke'
    
    steps:
    - name: ğŸ“¥ Checkout Kestrel Engine
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: ğŸ”§ Configure Hunt Environment
      run: |
        echo "ğŸ”§ Configuring ${{ github.event.inputs.environment || 'dev' }} environment"
        echo "ğŸ¯ API Target: JSONPlaceholder (no authentication required)"
        echo "ğŸ“Š Test Group: ${{ matrix.test-group }}"
        
    - name: ğŸ¯ Execute API Hunt Mission
      run: |
        chmod +x gradlew
        ./gradlew apiTests --info --continue \
          -Dtest.environment=${{ github.event.inputs.environment || 'dev' }} \
          -Dcucumber.filter.tags="${{ matrix.tags }}"
      env:
        CI: true
        
    - name: ğŸ“Š Generate API Hunt Evidence
      if: always()
      run: |
        echo "ğŸ“Š API Hunt Mission Complete"
        echo "ğŸ¯ Test Group: ${{ matrix.test-group }}"
        if [ -f "build/reports/cucumber/api-tests.html" ]; then
          echo "âœ… API hunt evidence generated successfully"
        else
          echo "âš ï¸ API hunt evidence not found"
        fi
        
    - name: ğŸ“¤ Upload API Hunt Evidence
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-hunt-evidence-${{ matrix.test-group }}-${{ github.event.inputs.environment || 'dev' }}
        path: |
          build/reports/cucumber/
          build/test-results/
          build/allure-results/
        retention-days: 30

  # Web Hunt Mission
  web-hunt:
    name: ğŸŒ Web Hunt - Demoblaze E-Commerce Mission
    runs-on: ubuntu-latest
    if: |
      (github.event.inputs.suite == 'all' || github.event.inputs.suite == 'web' || github.event.inputs.suite == 'e2e') ||
      github.event_name == 'pull_request'
    
    strategy:
      matrix:
        browser: [chrome]
        test-group: [auth, shopping, checkout]
        include:
          - test-group: auth
            tags: '@web and not @e2e'
            description: 'Authentication & Registration'
          - test-group: shopping
            tags: '@web and not @e2e and not @auth'
            description: 'Shopping Cart Operations'
          - test-group: checkout
            tags: '@web and @e2e'
            description: 'End-to-End Checkout'
    
    steps:
    - name: ğŸ“¥ Checkout Kestrel Engine
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: ğŸŒ Setup Browser Environment
      run: |
        # Update system packages
        sudo apt-get update
        
        # Install Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Verify installation
        google-chrome --version
        
    - name: ğŸ”§ Configure Browser Settings
      run: |
        echo "ğŸ”§ Configuring ${{ matrix.browser }} for headless operation"
        echo "ğŸ¯ Test Group: ${{ matrix.test-group }} - ${{ matrix.description }}"
        
    - name: ğŸŒ Execute Web Hunt Mission
      run: |
        chmod +x gradlew
        ./gradlew webTests --info --continue \
          -Dtest.environment=${{ github.event.inputs.environment || 'dev' }} \
          -Dbrowser=${{ github.event.inputs.browser || 'chrome' }} \
          -Dheadless=true \
          -Dcucumber.filter.tags="${{ matrix.tags }}"
      env:
        CI: true
        DISPLAY: :99
        
    - name: ğŸ“¸ Capture Web Hunt Evidence
      if: failure()
      run: |
        echo "ğŸ“¸ Capturing failure evidence for ${{ matrix.test-group }}"
        if [ -d "build/screenshots" ]; then
          ls -la build/screenshots/
        fi
        
    - name: ğŸ“Š Generate Web Hunt Report
      if: always()
      run: |
        echo "ğŸ“Š Web Hunt Complete - ${{ matrix.description }}"
        if [ -f "build/reports/cucumber/web-tests.html" ]; then
          echo "âœ… Web hunt evidence generated successfully"
        else
          echo "âš ï¸ Web hunt evidence not found"
        fi
        
    - name: ğŸ“¤ Upload Web Hunt Evidence
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: web-hunt-evidence-${{ matrix.test-group }}-${{ matrix.browser }}
        path: |
          build/reports/cucumber/
          build/test-results/
          build/screenshots/
          build/allure-results/
        retention-days: 30

  # End-to-End Critical Mission
  e2e-critical-mission:
    name: ğŸ¯ E2E Critical Mission - Complete Shopping Flow
    runs-on: ubuntu-latest
    if: |
      (github.event.inputs.suite == 'all' || github.event.inputs.suite == 'e2e') ||
      github.event_name == 'pull_request'
    needs: [api-hunt, web-hunt]
    
    steps:
    - name: ğŸ“¥ Checkout Kestrel Engine
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: ğŸŒ Setup Browser Environment
      run: |
        sudo apt-get update
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: ğŸ¯ Execute E2E Critical Mission
      run: |
        chmod +x gradlew
        ./gradlew test --info --continue \
          -Dtest.environment=${{ github.event.inputs.environment || 'dev' }} \
          -Dbrowser=chrome \
          -Dheadless=true \
          -Dcucumber.filter.tags="@e2e and @critical"
      env:
        CI: true
        
    - name: ğŸ“¤ Upload E2E Mission Evidence
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-critical-mission-evidence
        path: |
          build/reports/cucumber/
          build/test-results/
          build/screenshots/
          build/allure-results/
        retention-days: 30

  # Performance & Load Testing
  performance-hunt:
    name: âš¡ Performance Hunt - API Load Testing
    runs-on: ubuntu-latest
    if: github.event.inputs.suite == 'all' || github.event.inputs.suite == 'performance'
    needs: [api-hunt]
    
    steps:
    - name: ğŸ“¥ Checkout Kestrel Engine
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: âš¡ Execute Performance Hunt
      run: |
        chmod +x gradlew
        ./gradlew apiTests --info --continue \
          -Dcucumber.filter.tags="@performance"
      env:
        CI: true
        
    - name: ğŸ“¤ Upload Performance Evidence
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-hunt-evidence
        path: |
          build/reports/cucumber/
          build/test-results/
        retention-days: 30

  # Security Reconnaissance
  security-scan:
    name: ğŸ”’ Security Reconnaissance
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout Kestrel Engine
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Execute Security Scan
      run: |
        echo "ğŸ”’ Performing security reconnaissance..."
        echo "ğŸ” Scanning for hardcoded credentials..."
        if grep -r "password\|secret\|key" src/ --include="*.java" | grep -v "\.password\|\.secret\|\.key"; then
          echo "âš ï¸ Potential security issue found"
        else
          echo "âœ… No obvious security issues detected"
        fi
        
    - name: ğŸ“Š Security Scan Report
      run: |
        echo "ğŸ“Š Security reconnaissance completed"
        echo "âœ… Kestrel Engine security protocols verified"

  # Mission Summary & Reporting
  mission-summary:
    name: ğŸ“‹ Mission Command Center - Final Report
    runs-on: ubuntu-latest
    if: always()
    needs: [quality-check, api-hunt, web-hunt, e2e-critical-mission]
    
    steps:
    - name: ğŸ“¥ Checkout for Mission Summary
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Generate Comprehensive Mission Report
      run: |
        cat << 'EOF' > mission-summary.md
        # ğŸ¦… Kestrel Engine - Hunt Mission Report
        
        **Mission Date:** $(date)
        **Trigger:** ${{ github.event_name }}
        **Suite:** ${{ github.event.inputs.suite || 'auto-triggered' }}
        **Environment:** ${{ github.event.inputs.environment || 'dev' }}
        **Browser:** ${{ github.event.inputs.browser || 'chrome' }}
        **API Target:** JSONPlaceholder (Authentication-Free Zone)
        **Web Target:** Demoblaze E-commerce Platform
        
        ## ğŸ¯ Hunt Mission Results
        
        | Mission Component | Status | Details |
        |-------------------|--------|---------|
        | **Quality Gates** | ${{ needs.quality-check.result || 'skipped' }} | Static analysis & code quality |
        | **API Hunt** | ${{ needs.api-hunt.result || 'skipped' }} | JSONPlaceholder reconnaissance |
        | **Web Hunt** | ${{ needs.web-hunt.result || 'skipped' }} | Demoblaze e-commerce testing |
        | **E2E Critical Mission** | ${{ needs.e2e-critical-mission.result || 'skipped' }} | Complete shopping workflow |
        
        ## ğŸ† Mission Assessment
        
        EOF
        
        # Calculate overall mission status
        if [[ "${{ needs.api-hunt.result }}" == "success" && "${{ needs.web-hunt.result }}" == "success" && "${{ needs.e2e-critical-mission.result }}" == "success" ]]; then
          cat << 'EOF' >> mission-summary.md
        ### âœ… MISSION STATUS: COMPLETE SUCCESS
        
        All hunt objectives accomplished with precision:
        - âœ… **API reconnaissance** completed successfully
        - âœ… **Web operations** executed flawlessly  
        - âœ… **End-to-end missions** concluded successfully
        - âœ… **Quality standards** maintained throughout
        
        **Kestrel Engine Performance:** EXCELLENT
        **Bug Detection Rate:** HIGH PRECISION
        **System Stability:** ROCK SOLID
        
        EOF
        elif [[ "${{ needs.api-hunt.result }}" == "success" || "${{ needs.web-hunt.result }}" == "success" ]]; then
          cat << 'EOF' >> mission-summary.md
        ### âš ï¸ MISSION STATUS: PARTIAL SUCCESS
        
        Some hunt objectives completed successfully:
        - ğŸ” Detailed investigation required for failed components
        - ğŸ“‹ Review failure evidence in artifacts
        - ğŸ”„ Consider retry with adjusted parameters
        
        EOF
        else
          cat << 'EOF' >> mission-summary.md
        ### âŒ MISSION STATUS: REQUIRES ATTENTION
        
        Hunt mission encountered obstacles:
        - ğŸ” **Immediate investigation required**
        - ğŸ“‹ **Review all failure evidence**
        - ğŸ› ï¸ **System diagnostics recommended**
        
        EOF
        fi
        
        cat << 'EOF' >> mission-summary.md
        ## ğŸ“Š Technical Specifications
        
        - **Framework:** Kestrel Engine v1.0.0
        - **Technology Stack:** Java 17 + Selenium 4 + Cucumber 7
        - **Architecture:** Page Object Model + BDD
        - **Execution:** Parallel multi-threaded
        - **Reporting:** HTML + JSON + Allure
        - **CI/CD:** GitHub Actions Matrix Strategy
        
        ## ğŸ¯ Coverage Metrics
        
        ### API Hunt Coverage:
        - âœ… **User Management:** GET, POST, PUT, DELETE operations
        - âœ… **Content Management:** Posts, filtering, pagination
        - âœ… **Error Handling:** 404, validation, edge cases
        - âœ… **Performance:** Load testing, response times
        - âœ… **Security:** Authentication simulation
        
        ### Web Hunt Coverage:
        - âœ… **Authentication:** Login, registration, logout
        - âœ… **Navigation:** Categories, products, search
        - âœ… **Shopping Cart:** Add, remove, modify items
        - âœ… **Checkout Process:** Complete end-to-end flow
        - âœ… **Form Validation:** Required fields, payment details
        - âœ… **Negative Scenarios:** Invalid inputs, edge cases
        
        ## ğŸ” Evidence Collection
        
        All mission evidence available in downloadable artifacts:
        - ğŸ“¸ **Screenshots:** Captured on failure + key steps
        - ğŸ“„ **HTML Reports:** Visual test execution summaries
        - ğŸ“Š **JSON Data:** Detailed execution metrics
        - ğŸ¯ **Allure Reports:** Enhanced interactive reporting
        - ğŸ“‹ **Console Logs:** Step-by-step execution traces
        
        ## ğŸš€ Next Steps
        
        1. **Download Artifacts:** Review all evidence files
        2. **Analyze Reports:** Check HTML/Allure reports for details
        3. **Address Failures:** Investigate any failed scenarios
        4. **Optimize Performance:** Review response times
        5. **Expand Coverage:** Add new scenarios as needed
        
        ---
        
        *Kestrel Engine: Hunting bugs with surgical precision* ğŸ¦…
        
        **"In the world of automation testing, precision is not just about finding bugsâ€”it's about hunting them with surgical accuracy, speed, and unwavering focus. That's the Kestrel way."**
        
        **Mission Report Generated:** $(date)
        **Operator:** Kestrel Engine Autonomous System
        **Status:** Ready for next hunt! ğŸ¯
        EOF
        
    - name: ğŸ“¤ Upload Comprehensive Mission Summary
      uses: actions/upload-artifact@v4
      with:
        name: kestrel-mission-summary-${{ github.run_number }}
        path: mission-summary.md
        retention-days: 90
        
    - name: ğŸ“‹ Display Mission Summary
      run: |
        echo "ğŸ“‹ KESTREL ENGINE MISSION SUMMARY:"
        echo "=================================="
        cat mission-summary.md
        echo "=================================="
        echo "ğŸ¯ Mission artifacts ready for download!"

  # Allure Report Generation (Optional)
  generate-allure-report:
    name: ğŸ“Š Generate Enhanced Allure Report
    runs-on: ubuntu-latest
    if: always() && (github.event.inputs.suite == 'all' || github.event_name == 'pull_request')
    needs: [api-hunt, web-hunt, e2e-critical-mission]
    
    steps:
    - name: ğŸ“¥ Checkout Kestrel Engine
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: ğŸ“¥ Download All Test Results
      uses: actions/download-artifact@v4
      with:
        pattern: '*-evidence-*'
        path: artifacts/
        merge-multiple: true
        
    - name: ğŸ“Š Generate Enhanced Allure Report
      run: |
        chmod +x gradlew
        
        # Combine all allure results
        mkdir -p build/allure-results
        find artifacts/ -name "*.json" -path "*/allure-results/*" -exec cp {} build/allure-results/ \; 2>/dev/null || true
        
        # Generate Allure report
        ./gradlew allureReport || echo "Allure report generation completed with warnings"
        
        echo "ğŸ“Š Enhanced Allure report generated"
        
    - name: ğŸ“¤ Upload Enhanced Allure Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: enhanced-allure-report
        path: build/reports/allure-report/
        retention-days: 30
        
    - name: ğŸ“‹ Allure Report Summary
      run: |
        echo "ğŸ¯ Enhanced Allure Report Available!"
        echo "ğŸ“Š Interactive report with:"
        echo "   âœ… Test execution timeline"
        echo "   ğŸ“ˆ Trends and statistics"
        echo "   ğŸ“¸ Screenshots and evidence"
        echo "   ğŸ” Detailed failure analysis"
        echo "   ğŸ“‹ Step-by-step execution"

# Notification & Integration (Optional)
  notify-completion:
    name: ğŸ“¢ Mission Completion Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [mission-summary]
    
    steps:
    - name: ğŸ“¢ Mission Status Notification
      run: |
        echo "ğŸ¦… KESTREL ENGINE MISSION COMPLETE!"
        echo "=================================="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Trigger: ${{ github.event_name }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run: ${{ github.run_number }}"
        echo "=================================="
        echo "ğŸ“Š All mission artifacts available for download"
        echo "ğŸ¯ Review results and download evidence"
        echo "ğŸ” Check Allure reports for detailed analysis"
        echo "=================================="
        echo "Ready for next hunt! ğŸ¦…"